<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>js-racing</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body style="overflow: hidden; background-color: black; cursor: none; color: white">

    <script src="gl-matrix-min.js"></script>
    <script src="webgl-obj-loader.min.js"></script>
<script>var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.arrayIteratorImpl=function(a){var b=0;return function(){return b<a.length?{done:!1,value:a[b++]}:{done:!0}}};$jscomp.arrayIterator=function(a){return{next:$jscomp.arrayIteratorImpl(a)}};$jscomp.makeIterator=function(a){var b="undefined"!=typeof Symbol&&Symbol.iterator&&a[Symbol.iterator];return b?b.call(a):$jscomp.arrayIterator(a)};$jscomp.arrayFromIterator=function(a){for(var b,c=[];!(b=a.next()).done;)c.push(b.value);return c};
$jscomp.arrayFromIterable=function(a){return a instanceof Array?a:$jscomp.arrayFromIterator($jscomp.makeIterator(a))};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;$jscomp.objectCreate=$jscomp.ASSUME_ES5||"function"==typeof Object.create?Object.create:function(a){var b=function(){};b.prototype=a;return new b};$jscomp.underscoreProtoCanBeSet=function(){var a={a:!0},b={};try{return b.__proto__=a,b.a}catch(c){}return!1};
$jscomp.setPrototypeOf="function"==typeof Object.setPrototypeOf?Object.setPrototypeOf:$jscomp.underscoreProtoCanBeSet()?function(a,b){a.__proto__=b;if(a.__proto__!==b)throw new TypeError(a+" is not extensible");return a}:null;
$jscomp.inherits=function(a,b){a.prototype=$jscomp.objectCreate(b.prototype);a.prototype.constructor=a;if($jscomp.setPrototypeOf){var c=$jscomp.setPrototypeOf;c(a,b)}else for(c in b)if("prototype"!=c)if(Object.defineProperties){var d=Object.getOwnPropertyDescriptor(b,c);d&&Object.defineProperty(a,c,d)}else a[c]=b[c];a.superClass_=b.prototype};
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(a,b,c){a!=Array.prototype&&a!=Object.prototype&&(a[b]=c.value)};$jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global&&null!=global?global:a};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.polyfill=function(a,b,c,d){if(b){c=$jscomp.global;a=a.split(".");for(d=0;d<a.length-1;d++){var e=a[d];e in c||(c[e]={});c=c[e]}a=a[a.length-1];d=c[a];b=b(d);b!=d&&null!=b&&$jscomp.defineProperty(c,a,{configurable:!0,writable:!0,value:b})}};
$jscomp.polyfill("Math.hypot",function(a){return a?a:function(a){if(2>arguments.length)return arguments.length?Math.abs(arguments[0]):0;var b,d,e;for(b=e=0;b<arguments.length;b++)e=Math.max(e,Math.abs(arguments[b]));if(1E100<e||1E-100>e){if(!e)return e;for(b=d=0;b<arguments.length;b++){var f=Number(arguments[b])/e;d+=f*f}return Math.sqrt(d)*e}for(b=d=0;b<arguments.length;b++)f=Number(arguments[b]),d+=f*f;return Math.sqrt(d)}},"es6","es3");$jscomp.SYMBOL_PREFIX="jscomp_symbol_";
$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};$jscomp.SymbolClass=function(a,b){this.$jscomp$symbol$id_=a;$jscomp.defineProperty(this,"description",{configurable:!0,writable:!0,value:b})};$jscomp.SymbolClass.prototype.toString=function(){return this.$jscomp$symbol$id_};
$jscomp.Symbol=function(){function a(c){if(this instanceof a)throw new TypeError("Symbol is not a constructor");return new $jscomp.SymbolClass($jscomp.SYMBOL_PREFIX+(c||"")+"_"+b++,c)}var b=0;return a}();
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var a=$jscomp.global.Symbol.iterator;a||(a=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("Symbol.iterator"));"function"!=typeof Array.prototype[a]&&$jscomp.defineProperty(Array.prototype,a,{configurable:!0,writable:!0,value:function(){return $jscomp.iteratorPrototype($jscomp.arrayIteratorImpl(this))}});$jscomp.initSymbolIterator=function(){}};
$jscomp.initSymbolAsyncIterator=function(){$jscomp.initSymbol();var a=$jscomp.global.Symbol.asyncIterator;a||(a=$jscomp.global.Symbol.asyncIterator=$jscomp.global.Symbol("Symbol.asyncIterator"));$jscomp.initSymbolAsyncIterator=function(){}};$jscomp.iteratorPrototype=function(a){$jscomp.initSymbolIterator();a={next:a};a[$jscomp.global.Symbol.iterator]=function(){return this};return a};
$jscomp.iteratorFromArray=function(a,b){$jscomp.initSymbolIterator();a instanceof String&&(a+="");var c=0,d={next:function(){if(c<a.length){var e=c++;return{value:b(e,a[e]),done:!1}}d.next=function(){return{done:!0,value:void 0}};return d.next()}};d[Symbol.iterator]=function(){return d};return d};$jscomp.polyfill("Array.prototype.keys",function(a){return a?a:function(){return $jscomp.iteratorFromArray(this,function(a){return a})}},"es6","es3");
var Texture$$module$__$src$texture=function(a,b,c){this.tex=a.createTexture();a.bindTexture(a.TEXTURE_2D,this.tex);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.NEAREST);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.NEAREST);a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,b);this.w=b.width;this.h=b.height;this.pixels=null;c&&(this.pixels=this.readPixels(b))};
Texture$$module$__$src$texture.prototype.readPixels=function(a){var b=document.createElement("canvas");b.width=a.width;b.height=a.height;var c=b.getContext("2d");c.drawImage(a,0,0);a=c.getImageData(0,0,a.width,a.height);c=new Uint8Array(a.data.length);for(var d=0;d<a.data.length;++d)c[d]=a.data[d];b.remove();return c};Texture$$module$__$src$texture.prototype.bind=function(a){a.bindTexture(a.TEXTURE_2D,this.tex)};var module$__$src$texture={};module$__$src$texture.Texture=Texture$$module$__$src$texture;var Mesh$$module$__$src$mesh=function(a,b,c,d,e){this.elementCount=e.length;this.vertexBuffer=a.createBuffer();this.uvBuffer=a.createBuffer();this.normalBuffer=a.createBuffer();this.indexBuffer=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,this.vertexBuffer);a.bufferData(a.ARRAY_BUFFER,new Float32Array(b),a.STATIC_DRAW);a.bindBuffer(a.ARRAY_BUFFER,this.uvBuffer);a.bufferData(a.ARRAY_BUFFER,new Float32Array(c),a.STATIC_DRAW);a.bindBuffer(a.ARRAY_BUFFER,this.normalBuffer);a.bufferData(a.ARRAY_BUFFER,
new Float32Array(d),a.STATIC_DRAW);a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,this.indexBuffer);a.bufferData(a.ELEMENT_ARRAY_BUFFER,new Uint16Array(e),a.STATIC_DRAW)};
Mesh$$module$__$src$mesh.prototype.bind=function(a){a.bindBuffer(a.ARRAY_BUFFER,this.vertexBuffer);a.vertexAttribPointer(0,3,a.FLOAT,a.FALSE,0,0);a.bindBuffer(a.ARRAY_BUFFER,this.uvBuffer);a.vertexAttribPointer(1,2,a.FLOAT,a.FALSE,0,0);a.bindBuffer(a.ARRAY_BUFFER,this.normalBuffer);a.vertexAttribPointer(2,3,a.FLOAT,a.FALSE,0,0);a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,this.indexBuffer)};Mesh$$module$__$src$mesh.prototype.draw=function(a){a.drawElements(a.TRIANGLES,this.elementCount,a.UNSIGNED_SHORT,0)};
var module$__$src$mesh={};module$__$src$mesh.Mesh=Mesh$$module$__$src$mesh;var AssetLoader$$module$__$src$assets=function(a){this.loaded=this.total=0;this.textures=[];this.meshes=[];this.sounds=[];this.gl=a};AssetLoader$$module$__$src$assets.prototype.loadTexture=function(a,b,c){var d=this;++this.total;var e=new Image;e.onload=function(){d.textures[b]=new Texture$$module$__$src$texture(d.gl,e,c);++d.loaded};e.src=a};
AssetLoader$$module$__$src$assets.prototype.loadDocument=function(a,b){var c=this;++this.total;var d=new XMLHttpRequest;d.overrideMimeType("text/xml");d.open("GET",a,!0);d.onreadystatechange=function(){4==d.readyState&&("200"==String(d.status)&&b(d.responseText),++c.loaded)};d.send(null)};
AssetLoader$$module$__$src$assets.prototype.loadMesh=function(a,b){var c=this;this.loadDocument(a,function(a){a=new OBJ.Mesh(a);for(var d=1;d<a.textures.length;d+=2)a.textures[d]=1-a.textures[d];c.meshes[b]=new Mesh$$module$__$src$mesh(c.gl,new Float32Array(a.vertices),new Float32Array(a.textures),new Float32Array(a.vertexNormals),new Uint16Array(a.indices))})};
AssetLoader$$module$__$src$assets.prototype.addTextures=function(){for(var a=$jscomp.makeIterator(arguments),b=a.next();!b.done;b=a.next())b=b.value,this.loadTexture(b.src,b.name,b.preserve)};AssetLoader$$module$__$src$assets.prototype.addMeshes=function(){for(var a=$jscomp.makeIterator(arguments),b=a.next();!b.done;b=a.next())b=b.value,this.loadMesh(b.src,b.name)};AssetLoader$$module$__$src$assets.prototype.hasLoaded=function(){return 0==this.total||this.total==this.loaded};
AssetLoader$$module$__$src$assets.prototype.getLoadRatio=function(){return 0==this.total?1:this.loaded/this.total};var module$__$src$assets={};module$__$src$assets.AssetLoader=AssetLoader$$module$__$src$assets;var Vector2$$module$__$src$vector=function(a,b){this.x=null==a?0:a;this.y=null==b?0:b};Vector2$$module$__$src$vector.prototype.normalize=function(){var a=Math.hypot(this.x,this.y);.001>a||(this.x/=a,this.y/=a)};Vector2$$module$__$src$vector.prototype.clone=function(){return new Vector2$$module$__$src$vector(this.x,this.y)};var Vector3$$module$__$src$vector=function(a,b,c){this.x=null==a?0:a;this.y=null==b?0:b;this.z=null==c?0:c};
Vector3$$module$__$src$vector.prototype.normalize=function(){var a=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z);.001>a||(this.x/=a,this.y/=a,this.z/=a)};Vector3$$module$__$src$vector.prototype.scalarMul=function(a){this.x*=a;this.y*=a;this.z*=a};Vector3$$module$__$src$vector.prototype.clone=function(){return new Vector3$$module$__$src$vector(this.x,this.y,this.z)};var module$__$src$vector={};module$__$src$vector.Vector2=Vector2$$module$__$src$vector;module$__$src$vector.Vector3=Vector3$$module$__$src$vector;function negMod$$module$__$src$util(a,b){return 0>a?b- -a%b:a%b}function clamp$$module$__$src$util(a,b,c){return Math.max(b,Math.min(a,c))}
function toggleFullscreen$$module$__$src$util(a){document.webkitIsFullScreen||document.mozFullScreen?document.webkitExitFullscreen?document.webkitExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.exitFullscreen&&document.exitFullscreen():a.webkitRequestFullscreen?a.webkitRequestFullscreen():a.requestFullscreen?a.requestFullscreen():a.mozRequestFullScreen&&a.mozRequestFullScreen()}
function isInsideTriangle$$module$__$src$util(a,b,c,d,e,f,h,g){var k=a-c,l=b-d,m=0<(e-c)*l-(f-d)*k;return!(0<(h-c)*l-(g-d)*k==m||0<(h-e)*(b-f)-(g-f)*(a-e)!=m)}function cross$$module$__$src$util(a,b){return new Vector3$$module$__$src$vector(a.y*b.z-b.y*a.z,a.z*b.x-b.z*a.x,a.x*b.y-b.x*a.y)}function dot$$module$__$src$util(a,b){return a.x*b.x+a.y*b.y+a.z*b.z}function updateSpeedAxis$$module$__$src$util(a,b,c){a<b?a=Math.min(a+c,b):a>b&&(a=Math.max(a-c,b));return a}
function updateVectorMovement$$module$__$src$util(a,b,c,d){a.x=updateSpeedAxis$$module$__$src$util(a.x,b.x,Math.abs(a.x-b.x)/c*d);a.y=updateSpeedAxis$$module$__$src$util(a.y,b.y,Math.abs(a.y-b.y)/c*d);a.z=updateSpeedAxis$$module$__$src$util(a.z,b.z,Math.abs(a.z-b.z)/c*d);a.normalize()}var module$__$src$util={};module$__$src$util.clamp=clamp$$module$__$src$util;module$__$src$util.cross=cross$$module$__$src$util;module$__$src$util.dot=dot$$module$__$src$util;module$__$src$util.isInsideTriangle=isInsideTriangle$$module$__$src$util;
module$__$src$util.negMod=negMod$$module$__$src$util;module$__$src$util.toggleFullscreen=toggleFullscreen$$module$__$src$util;module$__$src$util.updateSpeedAxis=updateSpeedAxis$$module$__$src$util;module$__$src$util.updateVectorMovement=updateVectorMovement$$module$__$src$util;var Collider$$module$__$src$collider=function(a,b,c){this.pos=new Vector3$$module$__$src$vector(a,b,c);this.speed=new Vector3$$module$__$src$vector;this.target=new Vector3$$module$__$src$vector;this.shadowPos=new Vector3$$module$__$src$vector(a,b,c);this.height=0};
Collider$$module$__$src$collider.prototype.planeCollision=function(a,b,c){if(!isInsideTriangle$$module$__$src$util(this.pos.x,this.pos.z,a.x,a.z,b.x,b.z,c.x,c.z))return!1;b=new Vector3$$module$__$src$vector(b.x-a.x,b.y-a.y,b.z-a.z);c=new Vector3$$module$__$src$vector(c.x-a.x,c.y-a.y,c.z-a.z);c=cross$$module$__$src$util(b,c);if(1E-4>Math.abs(c.y))return!1;c.normalize();a=-(c.x*a.x+c.y*a.y+c.z*a.z);b=Math.abs(c.x*this.pos.x+c.y*this.pos.y+c.z*this.pos.z+a)/Math.sqrt(c.x*c.x+c.y*c.y+c.z*c.z);var d=-(this.pos.x*
c.x+this.pos.z*c.z+a)/c.y;this.shadowPos.y=d;this.pos.y-this.height<d+.5&&0>this.speed.y&&(this.speed.y=0,"function"==typeof this.setOrientation?this.setOrientation(d,c,a,b):this.pos.y=d+this.height)};var module$__$src$collider={};module$__$src$collider.Collider=Collider$$module$__$src$collider;var Camera$$module$__$src$camera=function(a,b,c){Collider$$module$__$src$collider.call(this,a,b,c);this.target=this.pos.clone();this.lookAt=new Vector3$$module$__$src$vector(a,b,c);this.dir=new Vector3$$module$__$src$vector;this.upTarget=this.up=0;this.height=1;this.distTarget=this.dist=10;this.speed.y=-1};$jscomp.inherits(Camera$$module$__$src$camera,Collider$$module$__$src$collider);
Camera$$module$__$src$camera.prototype.followRacer=function(a){this.lookAt=a.pos.clone();this.target=a.poseLeft.clone();this.upTarget=8*a.poseUp.y;this.distTarget=8+6*a.targetLen};
Camera$$module$__$src$camera.prototype.updateAnimation=function(a){this.dist=updateSpeedAxis$$module$__$src$util(this.dist,this.distTarget,.05*a.step);updateVectorMovement$$module$__$src$util(this.dir,this.target,16,a.step);this.pos.x=this.lookAt.x-this.dir.x*this.dist;this.pos.z=this.lookAt.z-this.dir.z*this.dist;this.pos.y=this.lookAt.y-this.dir.y*this.dist+this.up;this.up=updateSpeedAxis$$module$__$src$util(this.up,this.upTarget,Math.abs(this.up-this.upTarget)/16*a.step)};
Camera$$module$__$src$camera.prototype.use=function(a){a.setCamera(this.pos.x,this.pos.y,this.pos.z,this.lookAt.x,Math.max(0,this.lookAt.y)+3,this.lookAt.z)};var module$__$src$camera={};module$__$src$camera.Camera=Camera$$module$__$src$camera;var Shader$$module$__$src$shader=function(a,b,c){this.gl=a;this.unif=[];this.program=this.buildShader(b,c);this.getUniformLocations()};Shader$$module$__$src$shader.prototype.getUniformLocations=function(){for(var a=this.gl,b=$jscomp.makeIterator("transform rotation color t0 fogColor fogDensity lightDir lightMag pos size texPos texSize".split(" ")),c=b.next();!c.done;c=b.next())c=c.value,this.unif[c]=a.getUniformLocation(this.program,c)};
Shader$$module$__$src$shader.prototype.createShader=function(a,b){var c=this.gl;b=c.createShader(b);c.shaderSource(b,a);c.compileShader(b);if(!c.getShaderParameter(b,c.COMPILE_STATUS))throw"Shader error:\n"+c.getShaderInfoLog(b);return b};
Shader$$module$__$src$shader.prototype.buildShader=function(a,b){var c=this.gl;a=this.createShader(a,c.VERTEX_SHADER);b=this.createShader(b,c.FRAGMENT_SHADER);var d=c.createProgram();c.attachShader(d,a);c.attachShader(d,b);this.bindLocations(d);c.linkProgram(d);if(!c.getProgramParameter(d,c.LINK_STATUS))throw"Shader error: "+c.getProgramInfoLog(d);return d};
Shader$$module$__$src$shader.prototype.bindLocations=function(a){var b=this.gl;b.bindAttribLocation(a,0,"vertexPos");b.bindAttribLocation(a,1,"vertexUV");b.bindAttribLocation(a,2,"vertexNormal")};Shader$$module$__$src$shader.prototype.use=function(){var a=this.gl;a.useProgram(this.program);var b=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);a.uniform1i(this.unif.t0,0);this.setVertexTransform(0,0,0,1,1,1);this.setFragTransform(0,0,1,1);this.setRotationMatrix(b);this.setTransformMatrix(b)};
Shader$$module$__$src$shader.prototype.setVertexTransform=function(a,b,c,d,e,f){var h=this.gl;h.uniform3f(this.unif.pos,a,b,c);h.uniform3f(this.unif.size,d,e,f)};Shader$$module$__$src$shader.prototype.setFragTransform=function(a,b,c,d){var e=this.gl;e.uniform2f(this.unif.texPos,a,b);e.uniform2f(this.unif.texSize,c,d)};Shader$$module$__$src$shader.prototype.setColor=function(a,b,c,d){this.gl.uniform4f(this.unif.color,a,b,c,d)};
Shader$$module$__$src$shader.prototype.setTransformMatrix=function(a){this.gl.uniformMatrix4fv(this.unif.transform,!1,a)};Shader$$module$__$src$shader.prototype.setRotationMatrix=function(a){this.gl.uniformMatrix4fv(this.unif.rotation,!1,a)};Shader$$module$__$src$shader.prototype.setFog=function(a,b,c,d){var e=this.gl;e.uniform4f(this.unif.fogColor,b,c,d,1);e.uniform1f(this.unif.fogDensity,a)};
Shader$$module$__$src$shader.prototype.setLight=function(a,b,c,d){var e=this.gl;e.uniform3f(this.unif.lightDir,b,c,d);e.uniform1f(this.unif.lightMag,a)};var module$__$src$shader={};module$__$src$shader.Shader=Shader$$module$__$src$shader;var ShaderType$$module$__$src$shadersrc={DefaultTextured:0,DefaultNoTexture:1,TexturedFogAndLight:2},VertexDefault$$module$__$src$shadersrc="\nattribute vec3 vertexPos;\nattribute vec2 vertexUV;\nattribute vec3 vertexNormal;\n   \nuniform mat4 transform;\nuniform mat4 rotation;\nuniform vec3 pos;\nuniform vec3 size;\n\nuniform vec3 lightDir;\nuniform float lightMag;\n\nvarying vec2 uv;\nvarying float light;\n   \nvoid main() {\n    vec3 p = vertexPos * size + pos;\n    vec4 o = transform * vec4(p, 1);\n    gl_Position = o;\n    \n    uv = vertexUV;\n    \n    vec3 rot = (rotation * vec4(vertexNormal,1)).xyz;\n    light = (1.0-lightMag) + lightMag * dot(rot, lightDir);\n}",
VertexNoTex$$module$__$src$shadersrc="\nattribute vec3 vertexPos;\nattribute vec2 vertexUV;\nattribute vec3 vertexNormal;\n   \nuniform mat4 transform;\n\nuniform vec3 pos;\nuniform vec3 size;\n   \nvoid main() {\n    vec3 p = vertexPos * size + pos;\n    vec4 o = transform * vec4(p, 1);\n    gl_Position = o;\n}",FragFogAndLight$$module$__$src$shadersrc="\nprecision mediump float;\n \nuniform sampler2D t0;\nuniform vec4 color;\n\nuniform vec4 fogColor;\nuniform float fogDensity;\n\nuniform vec2 texPos;\nuniform vec2 texSize;\n\nvarying vec2 uv;\nvarying float light;\n\nvoid main() {\n\n    const float DELTA = 0.001;\n    vec2 tex = uv;    \n    tex.x *= texSize.x;\n    tex.y *= texSize.y;\n    tex += texPos;\n\n    vec4 res = color * texture2D(t0, tex);\n    if(res.a <= DELTA) {\n        discard;\n    }\n\n    vec4 a = gl_FragCoord;\n    float z = a.z / a.w;\n    float d = z * fogDensity;\n    float fog = 1.0 / exp(d*d);\n    fog = clamp(fog, 0.0, 1.0);\n\n    gl_FragColor = vec4((1.0-light)*(fog*res.xyz + (1.0-fog)*fogColor.xyz), res.a);\n}\n",
FragTex$$module$__$src$shadersrc="\nprecision mediump float;\n \nuniform sampler2D t0;\nuniform vec4 color;\n\nuniform vec2 texPos;\nuniform vec2 texSize;\n\nvarying vec2 uv;\n\nvoid main() {\n\n    const float DELTA = 0.001;\n    vec2 tex = uv;    \n    tex.x *= texSize.x;\n    tex.y *= texSize.y;\n    tex += texPos;\n\n    vec4 res = texture2D(t0, tex) * color;\n    if(color.a <= DELTA) {\n        discard;\n    }\n    gl_FragColor = res;\n}\n",FragNoTex$$module$__$src$shadersrc="\nprecision mediump float;\n\nuniform vec4 color;\n\nvoid main() {\n\n    gl_FragColor = color;\n}\n",
module$__$src$shadersrc={FragFogAndLight:FragFogAndLight$$module$__$src$shadersrc,FragNoTex:FragNoTex$$module$__$src$shadersrc,FragTex:FragTex$$module$__$src$shadersrc,ShaderType:ShaderType$$module$__$src$shadersrc,VertexDefault:VertexDefault$$module$__$src$shadersrc,VertexNoTex:VertexNoTex$$module$__$src$shadersrc};var Transformations$$module$__$src$transform=function(){this.model=glMatrix.mat4.create();this.view=glMatrix.mat4.create();this.projection=glMatrix.mat4.create();this.product=glMatrix.mat4.create();this.rotation=glMatrix.mat4.create();this.op=glMatrix.mat4.create();this.stack=[];this.rotStack=[];this.productComputed=!1;this.activeShader=null};Transformations$$module$__$src$transform.prototype.loadIdentity=function(){glMatrix.mat4.identity(this.model);glMatrix.mat4.identity(this.rotation)};
Transformations$$module$__$src$transform.prototype.translate=function(a,b,c){null==c&&(c=0);glMatrix.mat4.translate(this.model,this.model,glMatrix.vec3.fromValues(a,b,c));this.productComputed=!1};Transformations$$module$__$src$transform.prototype.scale=function(a,b,c){null==c&&(c=0);glMatrix.mat4.scale(this.model,this.model,glMatrix.vec3.fromValues(a,b,c));this.productComputed=!1};
Transformations$$module$__$src$transform.prototype.rotate=function(a,b,c,d){null==b&&(c=b=0,d=1);glMatrix.mat4.rotate(this.model,this.model,a,glMatrix.vec3.fromValues(b,c,d));glMatrix.mat4.rotate(this.rotation,this.rotation,a,glMatrix.vec3.fromValues(b,c,d));this.productComputed=!1};
Transformations$$module$__$src$transform.prototype.setBasis=function(a,b,c){this.op=glMatrix.mat4.fromValues(a.x,a.y,a.z,0,b.x,b.y,b.z,0,c.x,c.y,c.z,0,0,0,0,1);glMatrix.mat4.mul(this.model,this.model,this.op);glMatrix.mat4.mul(this.rotation,this.rotation,this.op)};Transformations$$module$__$src$transform.prototype.setCamera=function(a,b,c,d,e,f){glMatrix.mat4.lookAt(this.view,glMatrix.vec3.fromValues(a,b,c),glMatrix.vec3.fromValues(d,e,f),glMatrix.vec3.fromValues(0,1,0));this.productComputed=!1};
Transformations$$module$__$src$transform.prototype.setView2D=function(a,b){glMatrix.mat4.ortho(this.projection,0,a,b,0,-1,1);glMatrix.mat4.identity(this.view);this.productComputed=!1};Transformations$$module$__$src$transform.prototype.setPerspective=function(a,b,c,d){glMatrix.mat4.perspective(this.projection,a/180*Math.PI,b,c,d);this.productComputed=!1};
Transformations$$module$__$src$transform.prototype.push=function(){if(64==this.stack.length)throw"A risk for stack overflow!";this.stack.push(glMatrix.mat4.clone(this.model));this.rotStack.push(glMatrix.mat4.clone(this.rotation))};Transformations$$module$__$src$transform.prototype.pop=function(){this.model=this.stack.pop();this.rotation=this.rotStack.pop();this.productComputed=!1};
Transformations$$module$__$src$transform.prototype.computeProduct=function(){this.productComputed||(glMatrix.mat4.mul(this.product,this.view,this.model),glMatrix.mat4.mul(this.product,this.projection,this.product),this.productComputed=!0)};Transformations$$module$__$src$transform.prototype.useTransform=function(){null!=this.activeShader&&(this.computeProduct(),this.activeShader.setTransformMatrix(this.product),this.activeShader.setRotationMatrix(this.rotation))};var module$__$src$transform={};
module$__$src$transform.Transformations=Transformations$$module$__$src$transform;var Canvas$$module$__$src$canvas=function(a,b){Transformations$$module$__$src$transform.call(this);this.gl=this.canvas=null;this.w=a;this.h=b;this.cdiv=null;this.createHtml5Canvas(a,b);this.initGL(this.gl);this.clear(0,0,0);this.shaders=this.buildShaders();this.activeShader=this.shaders.noTex;this.activeShader.use();this.prevShader=this.activeShader;this.mRect=this.createRectMesh();this.mRectXZ=this.createRectMeshXZ();this.boundTex=this.boundMesh=null;this.resize(window.innerWidth,window.innerHeight)};
$jscomp.inherits(Canvas$$module$__$src$canvas,Transformations$$module$__$src$transform);Canvas$$module$__$src$canvas.prototype.createRectMesh=function(){return new Mesh$$module$__$src$mesh(this.gl,[0,0,0,1,0,0,1,1,0,0,1,0],[0,0,1,0,1,1,0,1],[0,0,1,0,0,1,0,0,1,0,0,1],[0,1,2,2,3,0])};Canvas$$module$__$src$canvas.prototype.createRectMeshXZ=function(){return new Mesh$$module$__$src$mesh(this.gl,[-.5,0,-.5,.5,0,-.5,.5,0,.5,-.5,0,.5],[0,0,1,0,1,1,0,1],[0,0,1,0,0,1,0,0,1,0,0,1],[0,1,2,2,3,0])};
Canvas$$module$__$src$canvas.prototype.buildShaders=function(){var a=this.gl,b=[];b.noTex=new Shader$$module$__$src$shader(a,VertexNoTex$$module$__$src$shadersrc,FragNoTex$$module$__$src$shadersrc);b.tex=new Shader$$module$__$src$shader(a,VertexDefault$$module$__$src$shadersrc,FragTex$$module$__$src$shadersrc);b.fogAndLight=new Shader$$module$__$src$shader(a,VertexDefault$$module$__$src$shadersrc,FragFogAndLight$$module$__$src$shadersrc);return b};
Canvas$$module$__$src$canvas.prototype.createHtml5Canvas=function(a,b){this.cdiv=document.createElement("div");this.cdiv.setAttribute("style","position: absolute; top: 0; left: 0; z-index: -1");this.canvas=document.createElement("canvas");this.canvas.width=a;this.canvas.height=b;this.canvas.setAttribute("style","position: absolute; top: 0; left: 0; z-index: -1;image-rendering: optimizeSpeed;image-rendering: pixelated;image-rendering: -moz-crisp-edges;");this.cdiv.appendChild(this.canvas);document.body.appendChild(this.cdiv);
this.gl=this.canvas.getContext("webgl",{alpha:!1,antialias:!1})};Canvas$$module$__$src$canvas.prototype.initGL=function(a){a.activeTexture(a.TEXTURE0);a.enable(a.DEPTH_TEST);a.enable(a.BLEND);a.blendFuncSeparate(a.SRC_ALPHA,a.ONE_MINUS_SRC_ALPHA,a.ONE,a.ONE_MINUS_SRC_ALPHA);a.enableVertexAttribArray(0);a.enableVertexAttribArray(1);a.enableVertexAttribArray(2);a.viewport(0,0,this.w,this.h)};
Canvas$$module$__$src$canvas.prototype.resizeCanvas=function(a,b,c,d,e){c=String(c|0)+"px";b=String(b|0)+"px";null!=d&&(a.style.height=String(e|0)+"px");null!=e&&(a.style.width=String(d|0)+"px");a.style.top=c;a.style.left=b};Canvas$$module$__$src$canvas.prototype.resize=function(a,b){var c=this.canvas;var d=Math.min(a/c.width|0,b/c.height|0);var e=c.width*d;d*=c.height;this.resizeCanvas(c,a/2-e/2,b/2-d/2,e,d)};
Canvas$$module$__$src$canvas.prototype.roundRect=function(a,b,c,d,e,f){var h=this.crtCtx;c=a+c;var g=b+d;h.lineWidth=String(f);h.beginPath();h.moveTo(a+e,b);h.lineTo(c-e,b);h.quadraticCurveTo(c,b,c,b+e);h.lineTo(c,b+d-e);h.quadraticCurveTo(c,g,c-e,g);h.lineTo(a+e,g);h.quadraticCurveTo(a,g,a,g-e);h.lineTo(a,b+e);h.quadraticCurveTo(a,b,a+e,b);h.stroke()};Canvas$$module$__$src$canvas.prototype.bindMesh=function(a){a!=this.boundMesh&&(this.boundMesh=a,a.bind(this.gl))};
Canvas$$module$__$src$canvas.prototype.bindTexture=function(a){a!=this.boundTex&&(this.boundTex=a,a.bind(this.gl))};Canvas$$module$__$src$canvas.prototype.clear=function(a,b,c){var d=this.gl;d.clear(d.DEPTH_BUFFER_BIT|d.COLOR_BUFFER_BIT);d.clearColor(a,b,c,1)};Canvas$$module$__$src$canvas.prototype.setColor=function(a,b,c,d){null==a?c=b=a=1:null==b&&(c=b=a);null==d&&(d=1);this.activeShader.setColor(a,b,c,d)};
Canvas$$module$__$src$canvas.prototype.fillRect=function(a,b,c,d){this.activeShader!=this.shaders.noTex&&(this.activeShader=this.shaders.noTex,this.activeShader.use());this.activeShader.setVertexTransform(a,b,0,c,d,0);this.bindMesh(this.mRect);this.mRect.draw(this.gl)};Canvas$$module$__$src$canvas.prototype.drawTexture=function(a,b,c,d,e){this.drawTextureRegion(a,0,0,a.w,a.h,b,c,d,e)};
Canvas$$module$__$src$canvas.prototype.drawTextureRegion=function(a,b,c,d,e,f,h,g,k){null==g&&(g=d);null==k&&(k=e);0>g&&(f-=g);0>k&&(h-=k);this.activeShader==this.shaders.noTex&&(this.activeShader=this.shaders.tex,this.activeShader.use());this.activeShader.setVertexTransform(f,h,0,g,k,1);this.activeShader.setFragTransform(b/a.w,c/a.h,d/a.w,e/a.h);this.bindMesh(this.mRect);this.bindTexture(a);this.mRect.draw(this.gl)};
Canvas$$module$__$src$canvas.prototype.drawText=function(a,b,c,d,e,f,h){var g=a.w/16;this.drawScaledText(a,b,c,d,e,f,g,g,h)};Canvas$$module$__$src$canvas.prototype.drawScaledText=function(a,b,c,d,e,f,h,g,k){var l=a.w/16,m=c,p=h/l,q=g/l;k&&(m=c-=b.length*(l+e)*p/2);for(var n=0;n<b.length;++n)k=b.charCodeAt(n),10==k?(m=c,d+=(l+f)*q):(this.drawTextureRegion(a,k%16*l,(k/16|0)*l,l,l,m,d,h,g),m+=(l+e)*p)};
Canvas$$module$__$src$canvas.prototype.resetCoordinateTransition=function(){this.activeShader.setVertexTransform(0,0,0,1,1,1);this.activeShader.setFragTransform(0,0,1,1)};Canvas$$module$__$src$canvas.prototype.drawMesh=function(a,b){this.bindTexture(b);this.bindMesh(a);a.draw(this.gl)};Canvas$$module$__$src$canvas.prototype.toggleDepthTest=function(a){a?this.gl.enable(this.gl.DEPTH_TEST):this.gl.disable(this.gl.DEPTH_TEST)};
Canvas$$module$__$src$canvas.prototype.toggleFogAndLighting=function(a){a&&this.activeShader!=this.shaders.fogAndLight?(this.prevShader=this.activeShader,this.activeShader=this.shaders.fogAndLight,this.activeShader.use(),this.useTransform()):(this.activeShader=this.prevShader,this.activeShader.use())};Canvas$$module$__$src$canvas.prototype.setFog=function(a,b,c,d){this.activeShader.setFog(a,b,c,d)};
Canvas$$module$__$src$canvas.prototype.setLighting=function(a,b,c,d){this.activeShader.setLight(a,b,c,d)};var module$__$src$canvas={};module$__$src$canvas.Canvas=Canvas$$module$__$src$canvas;var State$$module$__$src$input={Up:0,Down:1,Pressed:2,Released:3},InputManager$$module$__$src$input=function(){var a=this;this.keys=[];this.action=[];this.prevent=[];window.addEventListener("keydown",function(b){a.keyPressed(b.keyCode)&&b.preventDefault()});window.addEventListener("keyup",function(b){a.keyReleased(b.keyCode)&&b.preventDefault()});window.addEventListener("mousemove",function(a){window.focus()});window.addEventListener("contextmenu",function(a){a.preventDefault()})};
InputManager$$module$__$src$input.prototype.keyPressed=function(a){this.keys[a]!=State$$module$__$src$input.Down&&(this.keys[a]=State$$module$__$src$input.Pressed);return this.prevent[a]};InputManager$$module$__$src$input.prototype.keyReleased=function(a){this.keys[a]!=State$$module$__$src$input.Up&&(this.keys[a]=State$$module$__$src$input.Released);return this.prevent[a]};InputManager$$module$__$src$input.prototype.updateActions=function(){for(var a in this.action)this.action[a].state=this.getKey(this.action[a].key)};
InputManager$$module$__$src$input.prototype.updateStates=function(){for(var a in this.keys)this.keys[a]==State$$module$__$src$input.Pressed?this.keys[a]=State$$module$__$src$input.Down:this.keys[a]==State$$module$__$src$input.Released&&(this.keys[a]=State$$module$__$src$input.Up)};InputManager$$module$__$src$input.prototype.getKey=function(a){return this.keys[a]|State$$module$__$src$input.Up};
InputManager$$module$__$src$input.prototype.addAction=function(a,b){this.action[a]={key:b,state:State$$module$__$src$input.Up};this.prevent.push(b)};var module$__$src$input={};module$__$src$input.InputManager=InputManager$$module$__$src$input;module$__$src$input.State=State$$module$__$src$input;var FrameEvent$$module$__$src$event=function(){this.step=1;this.scenes=[];this.activeScene=null;this.input=new InputManager$$module$__$src$input};FrameEvent$$module$__$src$event.prototype.initScenes=function(a){for(var b=$jscomp.makeIterator(this.scenes),c=b.next();!c.done;c=b.next())c=c.value,null!=c.init&&c.init(this,a)};FrameEvent$$module$__$src$event.prototype.update=function(){this.input.updateActions();null!=this.activeScene&&null!=this.activeScene.update&&this.activeScene.update(this);this.input.updateStates()};
FrameEvent$$module$__$src$event.prototype.drawScene=function(a){null!=this.activeScene&&null!=this.activeScene.draw&&this.activeScene.draw(a)};FrameEvent$$module$__$src$event.prototype.addScene=function(a,b){this.scenes.push(a);b&&(this.activeScene=a)};var module$__$src$event={};module$__$src$event.FrameEvent=FrameEvent$$module$__$src$event;var Core$$module$__$src$core=function(a){var b=this;this.frameRate=this.getConfParam(a,"frameRate",60);this.canvasWidth=this.getConfParam(a,"canvasWidth",320);this.canvasHeight=this.getConfParam(a,"canvasHeight",240);this.ev=new FrameEvent$$module$__$src$event;this.canvas=new Canvas$$module$__$src$canvas(this.canvasWidth,this.canvasHeight);this.assets=new AssetLoader$$module$__$src$assets(this.canvas.gl);this.ev.textures=this.assets.textures;this.canvas.textures=this.assets.textures;this.canvas.meshes=
this.assets.meshes;this.ev.step=60/this.frameRate;this.target=1E3/this.frameRate;window.addEventListener("resize",function(a){b.canvas.resize(window.innerWidth,window.innerHeight)});this.oldTime=this.timeSum=0;this.initialized=!1};Core$$module$__$src$core.prototype.getConfParam=function(a,b,c){return null==a||null==a[b]?c:a[b]};
Core$$module$__$src$core.prototype.loop=function(a){var b=this;this.timeSum+=a-this.oldTime;var c=Math.floor(this.timeSum/this.target)|0;5<c&&(this.timeSum=5*this.target,c=5);for(var d=0<c;0<c--;)this.assets.hasLoaded()&&(this.initialized||(this.ev.initScenes(this.canvas),this.ev.textures=null,this.initialized=!0),this.ev.update()),this.timeSum-=this.target,d=!0;d&&this.assets.hasLoaded()&&this.ev.drawScene(this.canvas);this.oldTime=a;window.requestAnimationFrame(function(a){return b.loop(a)})};
Core$$module$__$src$core.prototype.addScenes=function(){for(var a=!1,b=$jscomp.makeIterator(arguments),c=b.next();!c.done;c=b.next())this.ev.addScene(c.value,!a),a=!0};Core$$module$__$src$core.prototype.configActions=function(){for(var a=$jscomp.makeIterator(arguments),b=a.next();!b.done;b=a.next())b=b.value,this.ev.input.addAction(b.name,b.key)};Core$$module$__$src$core.prototype.run=function(){this.loop(0)};var module$__$src$core={};module$__$src$core.Core=Core$$module$__$src$core;var Racer$$module$__$src$racer=function(a,b,c,d){Collider$$module$__$src$collider.call(this,a,b,c);this.targetLen=0;this.front=new Vector3$$module$__$src$vector(0,0,1);this.left=new Vector3$$module$__$src$vector(-1,0,0);this.up=new Vector3$$module$__$src$vector(0,1,0);this.poseUp=this.up.clone();this.poseFront=this.front.clone();this.poseLeft=this.left.clone();this.frontDir=new Vector3$$module$__$src$vector(0,0,1);this.leftDir=new Vector3$$module$__$src$vector(-1,0,0);this.angleTarget=this.angleSpeed=
this.angle=0;this.ai=d;this.jumpTimer=0;this.jumpDir=new Vector3$$module$__$src$vector;this.canJump=!1;this.acc=this.moveDir=0};$jscomp.inherits(Racer$$module$__$src$racer,Collider$$module$__$src$collider);Racer$$module$__$src$racer.prototype.genRotation=function(){this.front.normalize();this.left.normalize();this.up.normalize()};
Racer$$module$__$src$racer.prototype.control=function(a){var b=0;a.input.action.left.state==State$$module$__$src$input.Down?b=1:a.input.action.right.state==State$$module$__$src$input.Down&&(b=-1);b*=1+Math.hypot(this.speed.x,this.speed.z);this.angleTarget=.033*b;b=1;this.moveDir=0;a.input.action.up.state==State$$module$__$src$input.Down?this.moveDir=1:a.input.action.down.state==State$$module$__$src$input.Down&&(this.moveDir=-1,b=.2);var c=this.moveDir*Math.sin(this.angle),d=this.moveDir*Math.cos(this.angle);
a=a.input.action.fire1.state;this.canJump&&a==State$$module$__$src$input.Pressed&&(this.jumpDir.x=this.up.x+c,this.jumpDir.y=this.up.y,this.jumpDir.z=this.up.z+d,this.jumpDir.normalize(),this.jumpTimer=15);0<this.jumpTimer&&a==State$$module$__$src$input.Released&&(this.jumpTimer=0);this.canJump&&(this.target.x=c*b,this.target.z=d*b,this.target.x+=b/2*this.up.x,this.target.z+=b/2*this.up.z);this.target.y=-1;this.targetLen=Math.hypot(this.target.x,this.target.z)};
Racer$$module$__$src$racer.prototype.move=function(a){var b=Math.hypot(this.speed.x,this.speed.z);this.canJump&&(this.acc=.01/Math.sqrt(Math.exp(b)),-1==this.moveDir&&(this.acc=.02,(1E-4>Math.abs(this.target.x)||0<=this.speed.x/this.target.x)&&(1E-4>Math.abs(this.target.y)||0<=this.speed.z/this.target.z)&&(this.acc=1)));0<this.jumpTimer&&(this.jumpTimer-=a.step,this.speed=this.jumpDir.clone(),this.speed.scalarMul(.75));this.speed.x=updateSpeedAxis$$module$__$src$util(this.speed.x,this.target.x,this.acc*
a.step);this.speed.z=updateSpeedAxis$$module$__$src$util(this.speed.z,this.target.z,this.acc*a.step);this.speed.y=updateSpeedAxis$$module$__$src$util(this.speed.y,this.target.y,.025*a.step);this.angleSpeed=updateSpeedAxis$$module$__$src$util(this.angleSpeed,this.angleTarget,.005*a.step);this.pos.x+=this.speed.x*a.step;this.pos.z+=this.speed.z*a.step;this.pos.y+=this.speed.y*a.step;this.angle+=this.angleSpeed*a.step;this.angle=negMod$$module$__$src$util(this.angle,2*Math.PI);updateVectorMovement$$module$__$src$util(this.poseFront,
this.front,10,a.step);updateVectorMovement$$module$__$src$util(this.poseLeft,this.left,10,a.step);updateVectorMovement$$module$__$src$util(this.poseUp,this.up,10,a.step);this.frontDir.x=Math.cos(this.angle);this.frontDir.z=-Math.sin(this.angle);this.leftDir.x=-this.frontDir.z;this.leftDir.z=this.frontDir.x;this.left=this.leftDir.clone();this.front=this.frontDir.clone();this.up=new Vector3$$module$__$src$vector(0,1,0);this.shadowPos.x=this.pos.x;this.shadowPos.y=this.pos.y};
Racer$$module$__$src$racer.prototype.update=function(a){this.ai||this.control(a);this.move(a);this.canJump=!1};Racer$$module$__$src$racer.prototype.drawShadow=function(a){var b=Math.max(0,4-(this.pos.y-this.shadowPos.y)/8);a.push();a.translate(this.pos.x,this.shadowPos.y,this.pos.z);a.setBasis(this.poseLeft,this.poseUp,this.poseFront);a.scale(b,1,b);a.useTransform();a.toggleDepthTest(!1);a.setColor(0,0,0,.25);a.drawMesh(a.mRectXZ,a.textures.shadow);a.toggleDepthTest(!0);a.pop();a.useTransform()};
Racer$$module$__$src$racer.prototype.draw=function(a){this.drawShadow(a);a.push();a.translate(this.pos.x,this.pos.y,this.pos.z);a.setBasis(this.poseLeft,this.poseUp,this.poseFront);a.useTransform();a.setColor();a.resetCoordinateTransition();a.drawMesh(a.meshes.horse,a.textures.donkey);a.pop()};
Racer$$module$__$src$racer.prototype.setOrientation=function(a,b,c,d){this.up=new Vector3$$module$__$src$vector(-b.x,-b.y,-b.z);this.front=new Vector3$$module$__$src$vector(this.frontDir.x,-((this.pos.x+this.frontDir.x)*b.x+(this.pos.z+this.frontDir.z)*b.z+c)/b.y-a,this.frontDir.z);this.front.normalize();this.left=cross$$module$__$src$util(this.front,this.up);this.left.normalize();this.canJump=!0;this.pos.y=a};var module$__$src$racer={};module$__$src$racer.Racer=Racer$$module$__$src$racer;var Surface$$module$__$src$surface=function(a,b){this.w=a.w;this.h=a.h;if(null==a.pixels)throw"Texture has no pixel data,construct a surface!";this.hmap=this.genHeightmap(a.pixels);this.mesh=this.genMesh(b.gl)};Surface$$module$__$src$surface.prototype.getHeightValue=function(a,b){a=negMod$$module$__$src$util(a,this.w);b=negMod$$module$__$src$util(b,this.h);return this.hmap[b*this.w+a]};
Surface$$module$__$src$surface.prototype.genHeightmap=function(a){for(var b=new Float32Array(this.w*this.h),c,d=0;d<this.h;++d)for(var e=0;e<this.w;++e)c=d*this.w*4+4*e,c=(a[c]+a[c+1]+a[c+2])/3/255,b[d*this.w+e]=c;return b};
Surface$$module$__$src$surface.prototype.computeSurfaceNormal=function(a,b,c){var d=c*this.w+b;var e=c*this.w+b+1;var f=(c+1)*this.w+b+1;var h=(c+1)*this.w+b;c=a[3*d];var g=a[3*d+1];var k=a[3*d+2];d=glMatrix.vec3.fromValues(a[3*e]-c,a[3*e+1]-g,a[3*e+2]-k);glMatrix.vec3.normalize(d,d);b=glMatrix.vec3.fromValues(a[3*f]-c,a[3*f+1]-g,a[3*f+2]-k);glMatrix.vec3.normalize(b,b);c=a[3*h];g=a[3*h+1];k=a[3*h+2];e=glMatrix.vec3.fromValues(a[3*e]-c,a[3*e+1]-g,a[3*e+2]-k);glMatrix.vec3.normalize(e,e);a=glMatrix.vec3.fromValues(a[3*
f]-c,a[3*f+1]-g,a[3*f+2]-k);glMatrix.vec3.normalize(a,a);f=glMatrix.vec3.create();glMatrix.vec3.cross(f,d,b);d=glMatrix.vec3.create();glMatrix.vec3.cross(d,e,a);a=glMatrix.vec3.fromValues(-.5*(f[0]+d[0]),-.5*(f[1]+d[1]),-.5*(f[2]+d[2]));glMatrix.vec3.normalize(a,a);return a};
Surface$$module$__$src$surface.prototype.genMesh=function(a){for(var b=1/this.w,c=1/this.h,d=[],e=[],f=[],h=[],g=0;g<this.h;++g)for(var k=0;k<this.w;++k)d.push(b*k,this.getHeightValue(k,g),c*g),e.push(k,g);for(b=0;b<this.h-1;++b)for(c=0;c<this.w-1;++c)h.push(b*this.w+c,b*this.w+c+1,(b+1)*this.w+c+1,(b+1)*this.w+c+1,(b+1)*this.w+c,b*this.w+c);for(c=0;c<this.h;++c)for(g=0;g<this.w;++g)g==this.w-1&&c==this.h-1&&f.push(f[3*((c-1)*this.w+g-1)],f[3*((c-1)*this.w+g-1)+1],f[3*((c-1)*this.w+g-1)+2]),g==this.w-
1?f.push(f[3*(c*this.w+g-1)],f[3*(c*this.w+g-1)+1],f[3*(c*this.w+g-1)+2]):c==this.h-1?f.push(f[3*((c-1)*this.w+g)],f[3*((c-1)*this.w+g)+1],f[3*((c-1)*this.w+g)+2]):(b=this.computeSurfaceNormal(d,g,c),f.push.apply(f,$jscomp.arrayFromIterable(b)));return new Mesh$$module$__$src$mesh(a,d,e,f,h)};var module$__$src$surface={};module$__$src$surface.Surface=Surface$$module$__$src$surface;var Stage$$module$__$src$stage=function(a,b,c,d,e){this.surf=new Surface$$module$__$src$surface(b.textures.surface,b);this.scale=new Vector3$$module$__$src$vector(c,d,e)};
Stage$$module$__$src$stage.prototype.surfaceCollision=function(a){var b=1/this.surf.w*this.scale.x,c=1/this.surf.h*this.scale.z,d=Math.floor((a.pos.x+this.scale.x/2)/b),e=Math.floor((a.pos.z+this.scale.z/2)/c);if(0>d||0>e||d>=this.surf.w||e>=this.surf.h)return!1;var f=d*b-this.scale.x/2,h=e*c-this.scale.z/2,g=new Vector3$$module$__$src$vector(f,this.surf.getHeightValue(d,e)*this.scale.y,h),k=new Vector3$$module$__$src$vector(f+b,this.surf.getHeightValue(d+1,e)*this.scale.y,h);b=new Vector3$$module$__$src$vector(f+
b,this.surf.getHeightValue(d+1,e+1)*this.scale.y,h+c);c=new Vector3$$module$__$src$vector(f,this.surf.getHeightValue(d,e+1)*this.scale.y,h+c);return a.planeCollision(g,k,b)||a.planeCollision(b,c,g)};Stage$$module$__$src$stage.prototype.getCollisions=function(a){this.surfaceCollision(a)};Stage$$module$__$src$stage.prototype.drawSurface=function(a){a.push();a.scale(this.scale.x,this.scale.y,this.scale.z);a.translate(-.5,0,-.5);a.useTransform();a.drawMesh(this.surf.mesh,a.textures.snow);a.pop()};
Stage$$module$__$src$stage.prototype.draw=function(a){this.drawSurface(a)};var module$__$src$stage={};module$__$src$stage.Stage=Stage$$module$__$src$stage;var Game$$module$__$src$game=function(){this.racers=[];this.angle=0;this.cam=null;this.reset()};Game$$module$__$src$game.prototype.reset=function(){this.racers=Array(1);for(var a=0;1>a;++a)this.racers[a]=new Racer$$module$__$src$racer(1E-4,32,1E-4,0<a);this.angle=new Vector3$$module$__$src$vector;this.cam=new Camera$$module$__$src$camera};Game$$module$__$src$game.prototype.init=function(a,b){this.stage=new Stage$$module$__$src$stage(a,b,512,48,512)};
Game$$module$__$src$game.prototype.update=function(a){for(var b=$jscomp.makeIterator(this.racers),c=b.next();!c.done;c=b.next())c=c.value,c.update(a),this.stage.getCollisions(c);this.cam.followRacer(this.racers[0]);this.cam.updateAnimation(a);this.stage.getCollisions(this.cam);-24>this.racers[0].pos.y&&this.reset()};
Game$$module$__$src$game.prototype.draw=function(a){a.clear(0);a.toggleDepthTest(!0);a.resetCoordinateTransition();a.setPerspective(70,a.w/a.h,.1,100);this.cam.use(a);a.loadIdentity();a.useTransform();a.toggleFogAndLighting(!0);a.setLighting(.625,this.cam.dir.x,this.cam.dir.y,this.cam.dir.z);a.setFog(.02,0,0,0);this.stage.draw(a);for(var b=$jscomp.makeIterator(this.racers),c=b.next();!c.done;c=b.next())c.value.draw(a);a.toggleDepthTest(!1);a.toggleFogAndLighting(!1);a.setView2D(a.w,a.h);a.useTransform();
a.setColor(1);a.drawText(a.textures.font,"USE ARROW KEYS TO MOVE,\nSPACE TO JUMP.",2,2,0,2)};var module$__$src$game={};module$__$src$game.Game=Game$$module$__$src$game;window.onload=function(){var a=new Core$$module$__$src$core({canvasWidth:320,canvasHeight:240,frameRate:60});a.addScenes(new Game$$module$__$src$game);a.assets.addTextures({name:"font",src:"assets/bitmaps/font.png"},{name:"donkey",src:"assets/bitmaps/donkey.png"},{name:"surface",src:"assets/bitmaps/surface.png",preserve:!0},{name:"snow",src:"assets/bitmaps/snow.png"},{name:"shadow",src:"assets/bitmaps/shadow.png"});a.assets.addMeshes({name:"horse",src:"assets/models/horse.obj"});a.configActions({name:"left",
key:37},{name:"up",key:38},{name:"right",key:39},{name:"down",key:40},{name:"fire1",key:32},{name:"fire2",key:90},{name:"start",key:13},{name:"back",key:27});a.run()};var module$__$src$main={};
</script>
</body>
</html>
